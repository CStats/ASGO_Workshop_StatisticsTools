---
title: "Example Analysis"
author: "Chris Brown"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
#Install R: https://cran.r-project.org/bin/windows/base/
#Install RStudio Desktop: https://www.rstudio.com/products/rstudio/download/

#Install packages (only need to do this once)
#install.packages(c("tidyverse", "survminer", "gtsummary"))


library(dplyr)  # data manipulation / readable code
library(survminer) # pretty survival plots
library(survival) # survival analsis
library(gtsummary)  # nice summary tables

knitr::opts_chunk$set(echo = FALSE, warning=FALSE)  # don't print code in output

data(cancer, package="survival")  # load example dataset

write.csv(cancer, "NCCTG_Lung_Cancer_Data.csv",na = "",row.names = FALSE)  # save dataset as CSV
```

# Dataset (from survival package)

Survival in patients with advanced lung cancer from the North Central Cancer Treatment Group. Performance scores rate how well the patient can perform usual daily activities.

- inst:	Institution code
- time:	Survival time in days
- status:	censoring status 1=censored, 2=dead
- age:	Age in years
- sex:	Male=1 Female=2
- ph.ecog:	ECOG performance score as rated by the physician. 0=asymptomatic, 1= symptomatic but completely ambulatory, 2= in bed <50% of the day, 3= in bed > 50% of the day but not bedbound, 4 = bedbound
- ph.karno:	Karnofsky performance score (bad=0-good=100) rated by physician
- pat.karno:	Karnofsky performance score as rated by patient
- meal.cal:	Calories consumed at meals
- wt.loss:	Weight loss in last six months (pounds)

# Table / tests

```{r}
cancer %>% 
  select(-time) %>% 
  tbl_summary(
    by=sex,
    type = list("inst"~"categorical")
  ) #%>%   add_p()
```

# Time to event

```{r}
cancer %>%  
  arrange(-time) %>%
  mutate(order = 1:n()) %>% 
  ggplot(aes(y=order, x=time, color=factor(status)))+
  geom_point()+
  geom_segment(aes(xstart=0, xend=time,yend=order),colour="black", x=0, alpha=0.5)+
  ylab("Participant (ordered by time)")+
  xlab("Time (days)")

```



## Kaplan Meier

```{r}
fit <- survfit(Surv(time, status) ~ sex, data = cancer)
plot(fit)
```


### via ggsurvplot 

```{r}
ggsurvplot(fit)
```

### make it pretty

```{r}
cancer_data = cancer %>% 
  mutate(
    months = time/30.4375,
    sex = factor(sex, levels=c(1,2), labels=c("male","female")),
    age_10 = age/10,
    ecog = if_else(ph.ecog ==4, 3, ph.ecog),
    ecog	= factor(ecog , levels=c(0,1,2,3), labels=c("0","1","2","3/4")),
    ph.karno_10	 = ph.karno	/10,
    meal.cal_1000 = meal.cal/1000,
    wt.loss_10 = wt.loss/10
  )
    

fit <- survfit(Surv(months, status) ~ sex, data= cancer_data)

ggsurvplot(
    fit,                     # survfit object with calculated statistics.
    data = cancer_data,  # data used to fit survival curves. 
    ylab="overall survival (%)",
    xlab="months",
    break.time.by = 3,
    conf.int = FALSE,
    legend = c(0.81,0.95),
    legned.title = "",
    surv.scale = "percent",
    xlim= c(0,28),
    #break.y.by=0.1,
    surv.median.line = "hv",
    palette = c("darkblue","darkorange"),
    #Standard configuration
    risk.table = c("nrisk_cumcensor"),#TRUE,       # show risk table.
    ggtheme = theme_survminer()+theme(),#theme_minimal(), # customize plot and risk table with a theme.
    tables.theme = theme_void() + theme(plot.title = element_text(size =10)),
    risk.table.y.text.col = T, # colour risk table text annotations.
    risk.table.y.text = FALSE, # show bars instead of names in text annotations
    axes.offset=FALSE,
    risk.table.fontsize =3,
    tables.height=0.2,
    #title = "Survival b"
    )
```


# Regression


```{r , echo=FALSE}
m1 <- coxph(Surv(months, status) ~ sex, data= cancer_data)
summary(m1)
```

easy to get a clean summary

```{r , echo=FALSE}
tbl_regression(m1,exponentiate = TRUE)
```

or visualise the model estimate

```{r , echo=FALSE}
ggforest(m1, data = cancer_data)
```

```{r}
tbl_uvregression(
  cancer_data,
  method = coxph,
  y = Surv(months, status),
  exponentiate = TRUE
) 
```


### MV model

```{r}
m2 <- coxph(Surv(months,status) ~ sex + age_10 + ecog + ph.karno_10 + meal.cal_1000 + wt.loss_10, data= cancer_data)
summary(m2)
```

```{r}
tbl_regression(m2,exponentiate = TRUE) #%>%   #add_global_p()
ggforest(m2, data = cancer_data)
```


